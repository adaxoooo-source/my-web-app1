name: CI

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“‹ Display build information
        run: |
          echo "========================================="
          echo "ğŸš€ CI Pipeline Started"
          echo "========================================="
          echo "ğŸ“¦ Repository: ${{ github.repository }}"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Author: ${{ github.actor }}"
          echo "â° Timestamp: $(date)"
          echo "========================================="

      - name: ğŸ” Validate HTML files
        run: |
          echo "Checking for required HTML files..."
          files=("index.html" "features.html")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file not found!"
              exit 1
            fi
          done

      - name: ğŸ§ª Run HTML validation tests
        run: |
          echo "Running HTML validation..."
          for file in *.html; do
            echo "Validating $file..."
            # Check for DOCTYPE
            if grep -q "<!DOCTYPE html>" "$file"; then
              echo "  âœ… DOCTYPE declaration found"
            else
              echo "  âŒ DOCTYPE declaration missing in $file"
              exit 1
            fi
            # Check for proper structure
            if grep -q "<html" "$file" && grep -q "</html>" "$file"; then
              echo "  âœ… HTML structure valid"
            else
              echo "  âŒ Invalid HTML structure in $file"
              exit 1
            fi
          done
          echo "âœ… All HTML files validated successfully!"

      - name: ğŸ³ Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t my-web-app:${{ github.sha }} .
          docker tag my-web-app:${{ github.sha }} my-web-app:latest
          echo "âœ… Docker image built successfully!"

      - name: ğŸ§ª Test Docker container
        run: |
          echo "Starting container for testing..."
          docker run -d --name test-container -p 8080:80 my-web-app:latest
          sleep 5
          echo "Testing HTTP response..."
          curl -f http://localhost:8080 || (echo "âŒ Container test failed" && exit 1)
          echo "âœ… Container test passed!"
          docker stop test-container
          docker rm test-container

      - name: ğŸ“¦ Create build artifact
        run: |
          mkdir -p build-output
          cp -r *.html *.css *.js build-output/ 2>/dev/null || true
          cp Dockerfile docker-compose.yml build-output/ 2>/dev/null || true
          echo "Build created at $(date)" > build-output/BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> build-output/BUILD_INFO.txt

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-app-build-${{ github.sha }}
          path: build-output/
          retention-days: 30

      - name: ğŸ“Š Build summary
        run: |
          echo "========================================="
          echo "âœ… CI Pipeline Completed Successfully!"
          echo "========================================="
          echo "ğŸ“¦ Artifact: web-app-build-${{ github.sha }}"
          echo "ğŸ³ Docker image: my-web-app:${{ github.sha }}"
          echo "========================================="
